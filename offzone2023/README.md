# История взлома бейджа offzone2023, часть 1

Вид спереди | Вид сзади
:-------------------------:|:-------------------------:
![](/offzone2023/badge1.jpg?raw=true) | ![](/offzone2023/badge3.jpg?raw=true) |

Ссылка из QR-кода: https://t.me/offzone2023_bot?start=161ddbfb6c92b688af0c2338a50faa92bb0269e97fc62cc25f4376b578593707

1. Найденные отличия от бейджа прошлого года
   
   1.1. 3 коннектора для аддонов вместо 2
   
   1.2. Другой микроконтроллер: STM32F030C8T6 вместо STM32F070F6P6: 64 КБ Flash-памяти вместо 32 КБ и 8 КБ SRAM вместо 6 КБ. Одной ночи для снятия дампа прошивки не хватило, докопировалась только к середине второго дня ( на будущее - нужно одновременной дампить с нескольких бейджей или использовать более быстрые атаки)
   
   1.3. Ссылка на регистрацию бейджа в telegram-боте тепепрь наклеена в виде QR-кода на сам бейдж, а не отображается на экране специального банкомата.
   
   1.4. ID бейджа и ключ hmac теперь не рассчитываются исходя из UID микроконтроллера, а зашиты в прошивку: 0x34 байта с адреса 0x0800FC00 теперь у всех разные, а в прошлом году на всех бейджах была одинаковая прошивка.

   1.5. К контактам UART теперь можно удобно припаять пины, чтобы не колхозить с проводами. В SWD-разъеме теперь 5 контактов вместо 4.

   1.6. На плате присутствует радио-модуль NRF M 24L01+

   1.7. Отсеки для батареек нормально припаяны к плане, а не приклеены на двустороннем скотче к плате.
   
2. Ссылки на ресурсы с полезной информацией

<b>[STM32F030C8T6 Datasheet](https://www.st.com/resource/en/datasheet/stm32f030c8.pdf)</b><br/>
<b>[STM32F030C8T6 Reference Manual](https://www.st.com/resource/en/reference_manual/rm0360-stm32f030x4x6x8xc-and-stm32f070x6xb-advanced-armbased-32bit-mcus-stmicroelectronics.pdf)</b><br/>
<b>[Dumping the flash of the Syscan 2015 badge](https://gist.github.com/egirault/7b3fe7041e1bf5e2258ed5df7083f14d)</b><br/>

Из железа потребуются ST-Link, Bus Pirate, логический анализатор KingstVis и провода.

3. На бейдже стоит контроллер STM32F030C8T6, в нем есть 64 KB Flash-памяти с прошивкой (0x10000 байт с адреса 0x08000000), 8 KB SRAM (0x2000 байт с адреса 0x20000000) и SystemMemory с OptionBytes (0x1000 байт с адреса 0x1FFFEC00). Также есть SWD-разьем (5 дырок) и UART-интерфейс для подключения к банкомату и магазинным киоскам (4 металлизированные полоски снизу). Подключаемся ST-Link по протоколу SWD и считываем OptionBytes:

![OptionBytes](/offzone2023/STM32F030C8T6_OptionBytes.png?raw=true "Option Bytes")

Контроллер заблокирован до уровня "Level 1", что означает, что SRAM и SystemMemory можно считывать программатором, а Flash нельзя.
В SRAM ничего интересного не нашлось (правда особо и не искал), а в SystemMemory (сохранил ее в файл <b>STM32F030C8T6_0x1FFFEC00_0x1000_SystemMemory.bin </b>) помимо прочего хранится уникальный идентификатор чипа U_ID по адресу 0x1FFFF7AC. В моем случае это <b>0x33004D001251323250353820</b> (X-координата чипа на пластине кремния = 0x0033, Y-координата чипа на пластине кремния=0x004D, LOT_NUM=0x12, WAF_NUM="Q22P58 "). Так как на контроллерах на всех бейджах маркировка одинаковая "STM32F / 030C8T6 / AA042 0598 / TWN AA 130 / ST e3 1", можно сделать вывод, что они из одной партии, и U_ID отличаются только X и Y координатами (первыми 4 байтами).

На одном из стендов, где начисляют оффкойн за выполненные задания, подсматриваем ID бейджа в системе: <b>2068ab56d4c3a09a8cc7f681</b>

![Badge2](/offzone2023/badge2.jpg?raw=true "Badge2")

однако, как в прошлом году, не удалось найти хеш-фукнцию, чтобы ID в системе был равен результату применения хеш-фукнции к U_ID контроллера. Возможно, теперь используется hash_hmac с каким-то секретным ключом.

3. Теперь настало время доставать прошивку. Проще всего (правда долго ~ 16 часов) это сделать с помощью BusPirate по аналогии с бейджом на конференции syscan2015 (после подачи питания на контроллер есть несколько микросекунд чтобы считать 4 байта прошивки, пока не активировалась защита от считывания Level 1). Для хорошего контакта в бейдж были впаены 5 пинчиков. К середине второго дня конференции получился файл прошивки <b>STM32F030C8T6_0x08000000_0x10000_Flash.bin</b>.

...фото добавлю попозже...

4. Как оказалось, в прошивке не хранится балланс оффкойнов. Вместо этого по адресу 0x0800FC00 хранится 0x34 байта (на каждом бейдже разные):

![fw1](/offzone2023/fw1.png?raw=true "fw1")

В моем случае - это 20 байт "2068AB56D4C3A09A8CC7F681E063D5310005B0EA" (sha1 или hmac_sha1 от чего-то), первые 12 байт из которых используются как ID бейджа в системе, а также 32 байта "AB03049350CCA72D693D2086974C879696B1764F4177D98365DC0E6AE90A36E5" (далее - KEY1), которые используются как ключ hmac_sha1 при общении по UART-разьему.

5. Чтобы проверить, что передается по UART-разьему, к бейджу был подключен логический анализатор KingstVis и записаны трейсы в случае автономной работе и при подключении бейджа к стенду для начисления оффкойонов. При анализе трейсов можно заметить, что бейдж ничего не принимает по UART-интерфейсу, а только каждые 550 мс отправляет 40 байт:

![reader1](/offzone2023/reader1.jpg?raw=true "reader1")

![uart1](/offzone2023/uart1.png?raw=true "uart1")

~~~

2068ab56d4c3a09a8cc7f681 f42e6305be8b8477 ed4f6a6e51d943149e9b76017a984be5c15618e5
2068ab56d4c3a09a8cc7f681 909517653b6c34bc 8ff5083445d123be323504545ed33ddccb77e9fd
2068ab56d4c3a09a8cc7f681 1c9e0311b5137f61 9041fe8b30d9f260e0492ca103f12dda173796a8
...

~~~

Первые 12 байт - ID бейджа в системе, следующие 8 байт случайные, последние 20 байт - hmac_sha1 от первых 20 байт, рассчитанный с использованием KEY1. 

![ida1](/offzone2023/ida1.png?raw=true "ida1")

Для проверки hmac_sha1 был написан скрипт parse.php:

~~~

<?php

  $A = hex2bin("2068AB56D4C3A09A8CC7F681");
  $B = hex2bin("E063D5310005B0EA");
  $C = hex2bin("AB03049350CCA72D693D2086974C879696B1764F4177D98365DC0E6AE90A36E5");

  $s = file_get_contents($argv[1]);
  preg_match_all('#[\d\.\-]+,0x(\w{2}),,#', $s, $matches);
  $s = implode("", $matches[1]);
  $s = wordwrap($s, 80, "\n", true);

  $s = explode("\n", $s);
  foreach($s as $r)
  {
    $r = hex2bin($r);
    assert(substr($r, 0, 12) === $A);
    $x = substr($r, 12, 8);
    $y = substr($r, 20);
    echo bin2hex($A)." ".bin2hex($x)." ".bin2hex($y)." : ".hash_hmac("sha1", $A.$x, $C)."\n"; 
  }
  
~~~
   
6. На конференции было 2 задания с бейджами 2019 года. Первый их них - NFC. Считать прошивку с бейджа во время конференции не удалось (STM32F103, Readout Protection Level 1), однако в ней ничего интересного нет - просто читает Mifare-карту и выводит дамп в COM-порт. В принципе любой Android и Mifare Classic Tool сделает тоже самое.

![nfc1](/offzone2023/nfc1.jpg?raw=true "nfc1")

~~~
MIFARE module commands
0; - This command list
1,<block number>,<key A/B>,<key (12 hex symbols)>; - Read block. Example: 1,8,a,ffffffffffff;
2,<block number>,<key A/B>,<key (12 hex symbols)>,<data (32 hex symbols)>; - Write block. Example: 2,8,b,ffffffffffff,aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa;
3; - DuScan a MIFARE card...

...

   0      3   00 00 00 00  00 00 FF 07  80 69 FF FF  FF FF FF FF  [ 0 0 1 ]
          2   F1 2E BD 54  E6 C5 21 23  7A BA 31 0D  97 E2 C2 22  [ 0 0 0 ]
          1   52 65 65 64  2D 53 6F 6C  6F 6D 6F 6E  2F 6B 45 6B  [ 0 0 0 ]
          0   23 ED B8 A9  DF 08 04 00  62 63 64 65  66 67 68 69  [ 0 0 0 ]

Scan a MIFARE card...

~~~

На карте полезные данные есть только в первом секторе: "Reed-Solomon/kEk\xF1\x2E\xBD\x54\xE6\xC5\x21\x23\x7A\xBA\x31\x0D\x97\xE2\xC2\x22". Из читаемой части строки становится понятно, что нужно использовать ECC-коды для исправления ошибок. Пишем небольшой python-скрипт

~~~

from reedsolo import RSCodec, ReedSolomonError
rsc = RSCodec(16)
rsc.decode(bytearray(b'Reed-Solomon/kEk\xF1\x2E\xBD\x54\xE6\xC5\x21\x23\x7A\xBA\x31\x0D\x97\xE2\xC2\x22'))

~~~

и получаем флаг: "Rf1d-Solomon!FEC"

8. Второй задание связано с радио модулем. На конференции были раскиданы маяки, которые что-то посылали, отчего светодиоды на бейджах участников начинали мигать по-другому. Мне удалось найти 3 их них и скопировать с них прошивки. Реверс-инжиниринг будет в следующей статье ;)

![](/offzone2023/radio1.jpg?raw=true) | ![](/offzone2023/radio2.jpg?raw=true) | ![](/offzone2023/radio3.jpg?raw=true) |

9. В архиве <b>[firmware](/offzone2023/firmware.rar "firmware")</b> находятся файлы прошивки и uart-трейсы, снятые логическим анализатором, для моего бейджа, а также прошивки 3-х беджей от радио-таска, и оперативная память бейджа от NFC-таска

P.S.: чужие оффкойны не подстрадали ;)
