# История взлома бейджа offzone2022, часть 1

Вид спереди | Вид сзади
:-------------------------:|:-------------------------:
![](/offzone2022/badge1.jpg?raw=true) | ![](/offzone2022/badge3.jpg?raw=true) |

1. Ссылки на ресурсы с полезной информацией

<b>[STM32F070F6P6 Datasheet](https://www.st.com/resource/en/datasheet/stm32f070f6.pdf)</b><br/>
<b>[STM32F070F6P6 Reference Manual](https://www.st.com/resource/en/reference_manual/rm0360-stm32f030x4x6x8xc-and-stm32f070x6xb-advanced-armbased-32bit-mcus-stmicroelectronics.pdf)</b><br/>
<b>[Dumping the flash of the Syscan 2015 badge](https://gist.github.com/egirault/7b3fe7041e1bf5e2258ed5df7083f14d)</b><br/>

Из железа потребуются ST-Link, Bus Pirate и провода.

2. На бейдже стоит контроллер STM32F070F6P6, в нем есть 32 KB Flash-памяти с прошивкой (0x8000 байт с адреса 0x08000000), 6 KB SRAM (0x1800 байт с адреса 0x20000000) и SystemMemory с OptionBytes (0x3400 байт с адреса 0x1FFFC800). Также есть SWD-разьем (4 дырки) и UART-интерфейс для подключения к банкомату и магазинным киоскам (4 металлизированные полоски снизу). Подключаемся ST-Link по протоколу SWD и считываем OptionBytes:

![OptionBytes](/offzone2022/STM32F070F6P6_OptionBytes.png?raw=true "Option Bytes")

Контроллер заблокирован до уровня "Level 1", что означает, что SRAM и SystemMemory можно считывать программатором, а Flash нельзя.
В SRAM ничего интересного не нашлось (правда особо и не искал), а в SystemMemory (сохранил ее в файл <b>STM32F070F6P6_0x1FFFC800_0x3400_SystemMemory.bin</b>) помимо прочего хранится уникальный идентификатор чипа U_ID по адресу 0x1FFFF7AC. В моем случае это <b>0x180002001943505539363520</b> (X-координата чипа на пластине кремния = 0x0018, Y-координата чипа на пластине кремния=0x0002, LOT_NUM=0x19, WAF_NUM="CPU965 "). Так как на контроллерах на всех бейджах маркировка одинаковая "ST e4 78233 / STM32F070F6P6 / PHL 940 A", можно сделать вывод, что они из одной партии, и U_ID отличаются только X и Y координатами (первыми 4 байтами).

На компьютере одного магазина, торгующего товарами за offcoin, подсматриваем ID бейджа в системе: <b>8833f124f73c0a4a5232f7bf</b>

![Badge2](/offzone2022/badge2.png?raw=true "Badge2")

и путем небольного перебора хеш-функций получаем, что <b>ID=substr(sha1(U_ID), 0, 24)</b> (ID в системе - это первые 12 байт в хексе от SHA1 от идентификатора чипа).

3. Теперь настало время доставать прошивку. Проще всего (правда долго ~ 8 часов) это сделать с помощью BusPirate по аналогии с бейджом на конференции syscan2015 (после подачи питания на контроллер есть несколько микросекунд чтобы считать 4 байта прошивки, пока не активировалась защита от считывания Level 1). Для хорошего контакта в бейдж были впаены 4 пинчика. На утро второго дня получился файл прошивки <b>STM32F070F6P6_0x08000000_0x8000_Flash.bin</b>.

...фото добавлю попозже...

4. Как оказалось, в прошивке не хранится балланс оффкойнов, она только по протоколу UART сообщает свой идентификатор и контрольное значение хеш-функции. Тогда остается только научиться притворяться чужим бейджом. Перезаписать U_ID чипа нельзя, т.к. он хранится в OTP-области, но можно пропатчить прошивку, чтобы она считывала U_ID из другого места (из своего конца).

![ida1](/offzone2022/ida1.png?raw=true "ida1")

Чтобы не хулиганить с бейджами других участников, организаторы дали мне ID своего бейджа <b>0398bca47389cc845d3265f4</b>, по которому довольно быстро подобрался U_ID чипа <b>0x0d0006001943505539363520</b> и прошивка <b>fw_patched.bin</b>, притворяющаяся бейджом организатора, была успешно прошита и проверена ее работоспособность.

5. Анализ UART-траффика, записанного логическим анализатором при общении с банкоматом и магазинными киосками, а также алгоритм генерации ссылки для telegram-активации ожидаются будет в следующих частях ;)

6. В архиве <b>[firmware](/offzone2022/firmware.rar "firmware")</b> находятся файлы оригинальной, патченой прошивок, а также SystemMemory моего бейджа. На архиве стоит пароль в виде ID (не U_ID чипа!) еще одного бейджа в системе ( [0-9a-f]{24} ), так что вам придется немного попотеть ;)

P.S.: чужие оффкойны не подстрадали ;)
